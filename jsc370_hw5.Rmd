---
title: "A Look at NFL Field Goals - Interactive Visualizations"
author: "Chloe Nguyen"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
---


```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(plotly)
library(knitr)
library(widgetframe)
library(kableExtra)
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
library(leaflet)
library(mgcv)
library(stringr)
library(broom)
library(grid)   
library(jpeg)
```

## The Data 

First, we load in the data. Note that this data was already cleaned in the midterm report and so, no extra data wrangling is required. This data gives details on field goal plays in all National Football League (NFL) games from 2018 to 2020. Each row of the data represents a field goal attempt.

```{r data-prep, echo=FALSE, message=FALSE, warning=FALSE}
# Loading in and merging datasets
teams_abbrev <- read_csv("data/nfl_abbrev.csv")
# Substring to get team
teams_abbrev <- teams_abbrev %>%
  mutate(Team = sub('^(.+)[?=" "]', "", teams_abbrev$Name))
teams_loc <- read_csv("data/nfl_locations.csv")
# Fix naming conventions and teams that moved
teams_abbrev[teams_abbrev$Name=="Washington Football Team", "Team"] <- "Redskins"
teams_abbrev[teams_abbrev$Name=="San Francisco 49ers", "Team"] <- "Forty-Niners"
teams_loc[teams_loc$Team=="Rams", "longitude"] <- teams_loc[teams_loc$Team=="Chargers", "longitude"]
teams_loc[teams_loc$Team=="Rams", "latitude"] <- teams_loc[teams_loc$Team=="Chargers", "latitude"]
teams_loc[teams_loc$Team=="Rams", "zip"] <- teams_loc[teams_loc$Team=="Chargers", "zip"]
teams_loc[teams_loc$Team=="Raiders", "longitude"] <- -115.1833 
teams_loc[teams_loc$Team=="Raiders", "latitude"] <- 36.0909
teams_loc[teams_loc$Team=="Raiders", "zip"] <- 89118
teams_info <- merge(x=teams_abbrev,y=teams_loc,by="Team")



games <- read_csv("data/games.csv")
# Fix naming conventions
games[games$homeTeamAbbr=="LA", "homeTeamAbbr"] <- "LAR"
games[games$visitorTeamAbbr=="LA", "visitorTeamAbbr"] <- "LAR"
games[games$homeTeamAbbr=="OAK", "homeTeamAbbr"] <- "LV"
games[games$visitorTeamAbbr=="OAK", "visitorTeamAbbr"] <- "LV"

team_games <- merge(x=games,y=teams_info,by.x="homeTeamAbbr", by.y="Abbreviation", all.x=T)


plays <- read_csv("data/plays.csv")
# Fix naming conventions
plays[plays$possessionTeam=="LA", "possessionTeam"] <- "LAR"
plays[plays$possessionTeam=="OAK", "possessionTeam"] <- "LV"

data <- merge(x=plays,y=team_games, by="gameId", all.x=T)


data <- data %>%
  filter(specialTeamsPlayType=='Field Goal')


players <- read_csv("data/players.csv")

# Convert height in text of feet and inches to cm
players <- players %>% separate(height, c('feet', 'inches'), "-", convert=TRUE, remove = FALSE) %>%
  mutate(height_cm = ifelse(players$height %like% "-", 
                            (12*feet + inches)*2.54, 
                            as.numeric(height)*2.54))

# Change weight to kg
players <- players %>%
  mutate(weight_kg = weight*0.45359237)

# Convert birth date to Date
players$birthDate <- gsub('/', '-', players$birthDate)

players_a <- players %>%
  filter(!(players$birthDate %like% "-[0-9]{4}$")) %>%
  mutate(birthDate = as.Date(birthDate,'%Y-%m-%d'))

players_b <- players %>%
  filter(players$birthDate %like% "-[0-9]{4}$") %>%
  mutate(birthDate = as.Date(birthDate,'%m-%d-%Y'))

players <- rbind(players_a, players_b)



data <- merge(x=data,y=players,by.x="kickerId", by.y="nflId", all.x=T)


# Select relevant variables
data <- data%>%
  select(season, week, gameDate, gameTimeEastern, longitude, latitude, homeTeamAbbr, visitorTeamAbbr, quarter, down, specialTeamsPlayType, specialTeamsResult, possessionTeam, yardlineNumber, gameClock, kickLength, kickerId, height_cm, weight_kg, birthDate, displayName, collegeName, Position)

# Create needed variables
data <- data %>%
  # mutate(birthDate= as.Date(birthDate,'%Y-%m-%d')) %>%
  mutate(birthYear = as.numeric(format(birthDate,'%Y'))) %>%
  mutate(age = season-birthYear) %>%
  mutate(specialTeamsSuccess=ifelse(specialTeamsResult=='Kick Attempt Good', T, F)) %>%
  mutate(possessionTeamHome=ifelse(possessionTeam==homeTeamAbbr, T, F))

data <- data.table(data)


# Imputing missing values
data[, birthDate := fcoalesce(birthDate, median(birthDate, na.rm = TRUE)),
 by = .(possessionTeam, season)]
data[, birthYear := fcoalesce(birthYear, median(birthYear, na.rm = TRUE)),
 by = .(possessionTeam, season)]
data[, height_cm := fcoalesce(height_cm, median(height_cm, na.rm = TRUE)),
 by = .(possessionTeam, season)]
data[, kickLength := fcoalesce(kickLength, mean(kickLength, na.rm = TRUE)),
 by = .(possessionTeam, season)]
  data[, weight_kg:= fcoalesce(weight_kg, median(weight_kg, na.rm = TRUE)),
 by = .(possessionTeam, season)]
```

<br>

## Visualizations

Note that a successful field goal kick is a kick that manages to score points- that is, a kick that goes through the goal post.

First, we take a look at each team's field goal success rate by the starting yard line. From the visual below, we can see that the furthest successful kick attempts in 2018-2020 were between the 45-50 yard line and completed by the Dallas Cowboys (DAL) and the Carolina Panthers (CAR). Additionally, while most teams that attempted close field goal kicks (between the 0 to 5 yard line) have scored 100% of their attempts, the Miami Dolphins (MIA) and Philadelphia Eagles (PHI) looks to be less successful. The teams with the shortest max yard line successful kicks are the Minesota Vikings (MIN) and the New England Patriots (NE). Both teams's furthest successful kick were between the 30-35 yard line.

```{r, echo=FALSE, message=FALSE, warning=FALSE}

data <- data %>%
  mutate(yardlineInt = (findInterval(yardlineNumber, seq(0, 60, 5))-0.5)*5)

data_yardline <- data %>%
  group_by(yardlineInt, possessionTeam) %>%
  summarise (
    attempts = n(),
    prop_success = mean(specialTeamsSuccess))




data_yardline %>%
  plot_ly(x=~yardlineInt, y=~possessionTeam, z=~prop_success, type="heatmap",
          colorbar= list(title='Success Rate'),
          hoverinfo = 'text',
            text = ~paste("Team:", data_yardline$possessionTeam,
                          "<br> Yard Line:", data_yardline$yardlineInt-2.5, "to",
                          data_yardline$yardlineInt+2.5,
                          "<br> Success Rate:", round(data_yardline$prop_success, 2),
                          "<br> Attempts:", data_yardline$attempts)) %>%
  layout(title="Field Goal Attempt Success Rate by Yard Line per Team in 2018-2020", 
         yaxis=list(title="NFL Teams", autorange="reversed", dtick=1),
         xaxis=list(title="Yard Line"),
         hovermode="compare")


```

Next, we explore the proportion of successful kicks by average starting yard line in a season for each team. In this plot, each dot size corresponds to the number of field goal attempts made by each team in a season. Notice that the most season field goal success rates are above 65%. Moreover, we see that the Tennessee Titans (TEN) were significantly less successful in the 2019 season compared to all others NFL teams in all season between 2018 to 2020. In 2019, their success rate was only 33.33% with 15 attempts. From external knowledge, the Tennessee Titan's main kicker was injured at this time and hence, was unable to play- leading the team to go through four different kickers with evidently little success. The best seasons for any team in terms of proportion of successful field goal attempts had 100% success rate. These seasons are: 2020 Pittsburgh Steelers (PIT)- average yard line of 18.1 with 21 attempts, 2020 Green Bay Packers (GB)- average yard line of 22 with 15 attempts, and 2020 Seattle Seahawks (SEA)- average yard line of 22.9 with 20 attempts. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}

data_team_season <- data %>%
  group_by(possessionTeam, season) %>%
  summarise (
    attempts = n(),
    prop_success = mean(specialTeamsSuccess),
    avg_yardline = mean(yardlineNumber))

data_team_season %>%
  plot_ly(x=~avg_yardline, y=~prop_success, type='scatter',
          mode="markers", color=~possessionTeam,
          size=~attempts, sizes = c(5, 70), marker=list(sizemode='diameter', opacity = 0.5),
          hover_info="text",
          text = ~paste(paste0("Team: ", possessionTeam),
                        paste0("Season: ", season),
                        paste0("Number of Attempts: ", attempts),
                        paste0("Proportion of Successful Kicks: ", round(prop_success, 2)),
                        paste0("Average Yard Line: ", round(avg_yardline, 2)),
                        sep="<br>"))  %>%
  layout(title="Average Yard Line vs. Proportion of Successful Kicks <br> by Teams Each Season (2018-2020)", 
         yaxis=list(title="Proportion of Successful Kicks"),
         xaxis=list(title="Average Yard Line"),
         hovermode="compare")

```


Moving on, we examine the kick length of successful and unsuccessful field goal attempts. For every team, we see that the median kicking length is higher for successful kicks than for unsuccessful kicks. Of the successful kicks, the Denver Broncos (DEN) has the highest kick length median at roughly 40 yards. The lowest median for successful kicks belongs to the Las Vegas Raiders (LV) at 33 yards. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}

data %>% plot_ly(
  y = ~kickLength,
  x = ~possessionTeam,
  color = ~specialTeamsSuccess,
  type = "box"
) %>%
  layout(title="Kick Length of Successful and Unsuccessful Field Goal Attempts \n per Team for 2018-2020",
         yaxis=list(title="Kick length (yards)"),
         xaxis=list(title="Team"),
         legend=list(title=list(text='Successful Kicks')),
         hovermode="compare")
```






