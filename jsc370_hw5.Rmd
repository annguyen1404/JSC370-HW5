---
title: "JSC370 HW5 - Interactive Visualization"
author: "Chloe Nguyen"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
---


```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(plotly)
library(knitr)
library(widgetframe)
library(kableExtra)
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
library(leaflet)
library(mgcv)
library(stringr)
library(broom)
library(grid)   
library(jpeg)
```

## The Data 

First, we load in the data. Note that this data was already cleaned in the midterm report and so, no extra data wrangling is required. This data gives details on field goal plays in all National Football League (NFL) games from 2018 to 2020. Each row of the data represents a field goal attempt.

```{r data-prep, echo=FALSE, message=FALSE, warning=FALSE}
# Loading in and merging datasets
teams_abbrev <- read_csv("data/nfl_abbrev.csv")
# Substring to get team
teams_abbrev <- teams_abbrev %>%
  mutate(Team = sub('^(.+)[?=" "]', "", teams_abbrev$Name))
teams_loc <- read_csv("data/nfl_locations.csv")
# Fix naming conventions and teams that moved
teams_abbrev[teams_abbrev$Name=="Washington Football Team", "Team"] <- "Redskins"
teams_abbrev[teams_abbrev$Name=="San Francisco 49ers", "Team"] <- "Forty-Niners"
teams_loc[teams_loc$Team=="Rams", "longitude"] <- teams_loc[teams_loc$Team=="Chargers", "longitude"]
teams_loc[teams_loc$Team=="Rams", "latitude"] <- teams_loc[teams_loc$Team=="Chargers", "latitude"]
teams_loc[teams_loc$Team=="Rams", "zip"] <- teams_loc[teams_loc$Team=="Chargers", "zip"]
teams_loc[teams_loc$Team=="Raiders", "longitude"] <- -115.1833 
teams_loc[teams_loc$Team=="Raiders", "latitude"] <- 36.0909
teams_loc[teams_loc$Team=="Raiders", "zip"] <- 89118
teams_info <- merge(x=teams_abbrev,y=teams_loc,by="Team")



games <- read_csv("data/games.csv")
# Fix naming conventions
games[games$homeTeamAbbr=="LA", "homeTeamAbbr"] <- "LAR"
games[games$visitorTeamAbbr=="LA", "visitorTeamAbbr"] <- "LAR"
games[games$homeTeamAbbr=="OAK", "homeTeamAbbr"] <- "LV"
games[games$visitorTeamAbbr=="OAK", "visitorTeamAbbr"] <- "LV"

team_games <- merge(x=games,y=teams_info,by.x="homeTeamAbbr", by.y="Abbreviation", all.x=T)


plays <- read_csv("data/plays.csv")
# Fix naming conventions
plays[plays$possessionTeam=="LA", "possessionTeam"] <- "LAR"
plays[plays$possessionTeam=="OAK", "possessionTeam"] <- "LV"

data <- merge(x=plays,y=team_games, by="gameId", all.x=T)


data <- data %>%
  filter(specialTeamsPlayType=='Field Goal')


players <- read_csv("data/players.csv")

# Convert height in text of feet and inches to cm
players <- players %>% separate(height, c('feet', 'inches'), "-", convert=TRUE, remove = FALSE) %>%
  mutate(height_cm = ifelse(players$height %like% "-", 
                            (12*feet + inches)*2.54, 
                            as.numeric(height)*2.54))

# Change weight to kg
players <- players %>%
  mutate(weight_kg = weight*0.45359237)

# Convert birth date to Date
players$birthDate <- gsub('/', '-', players$birthDate)

players_a <- players %>%
  filter(!(players$birthDate %like% "-[0-9]{4}$")) %>%
  mutate(birthDate = as.Date(birthDate,'%Y-%m-%d'))

players_b <- players %>%
  filter(players$birthDate %like% "-[0-9]{4}$") %>%
  mutate(birthDate = as.Date(birthDate,'%m-%d-%Y'))

players <- rbind(players_a, players_b)



data <- merge(x=data,y=players,by.x="kickerId", by.y="nflId", all.x=T)


# Select relevant variables
data <- data%>%
  select(season, week, gameDate, gameTimeEastern, longitude, latitude, homeTeamAbbr, visitorTeamAbbr, quarter, down, specialTeamsPlayType, specialTeamsResult, possessionTeam, yardlineNumber, gameClock, kickLength, kickerId, height_cm, weight_kg, birthDate, displayName, collegeName, Position)

# Create needed variables
data <- data %>%
  # mutate(birthDate= as.Date(birthDate,'%Y-%m-%d')) %>%
  mutate(birthYear = as.numeric(format(birthDate,'%Y'))) %>%
  mutate(age = season-birthYear) %>%
  mutate(specialTeamsSuccess=ifelse(specialTeamsResult=='Kick Attempt Good', T, F)) %>%
  mutate(possessionTeamHome=ifelse(possessionTeam==homeTeamAbbr, T, F))

data <- data.table(data)


# Imputing missing values
data[, birthDate := fcoalesce(birthDate, median(birthDate, na.rm = TRUE)),
 by = .(possessionTeam, season)]
data[, birthYear := fcoalesce(birthYear, median(birthYear, na.rm = TRUE)),
 by = .(possessionTeam, season)]
data[, height_cm := fcoalesce(height_cm, median(height_cm, na.rm = TRUE)),
 by = .(possessionTeam, season)]
data[, kickLength := fcoalesce(kickLength, mean(kickLength, na.rm = TRUE)),
 by = .(possessionTeam, season)]
  data[, weight_kg:= fcoalesce(weight_kg, median(weight_kg, na.rm = TRUE)),
 by = .(possessionTeam, season)]
```

<br>

## Visualizations

```{r, echo=FALSE, message=FALSE, warning=FALSE}

data <- data %>%
  mutate(yardlineInt = findInterval(yardlineNumber, seq(0, 60, 5))*5)

data_yardline <- data %>%
  group_by(yardlineInt, possessionTeam) %>%
  summarise (
    attempts = n(),
    prop_success = mean(specialTeamsSuccess))




data_yardline %>%
  plot_ly(x=~yardlineInt, y=~possessionTeam, z=~prop_success, type="heatmap",
          colorbar= list(title='Success Rate'),
          hoverinfo = 'text',
            text = ~paste("Team:", data_yardline$possessionTeam,
                          "<br> Yard Line:", data_yardline$yardlineInt,
                          "<br> Success Rate:", round(data_yardline$prop_success, 2),
                          "<br> Attempts:", data_yardline$attempts)) %>%
  layout(title="Field Goal Attempt Success Rate by Yard Line in 2018-2020", 
         yaxis=list(title="NFL Teams", autorange="reversed"),
         xaxis=list(title="Yard Line"),
         hovermode="compare")


```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

data_team_season <- data %>%
  group_by(possessionTeam, season) %>%
  summarise (
    attempts = n(),
    prop_success = mean(specialTeamsSuccess),
    avg_yardline = mean(yardlineNumber))

data_team_season %>%
  plot_ly(x=~avg_yardline, y=~prop_success, type='scatter',
          mode="markers", color=~possessionTeam,
          size=~attempts, sizes = c(5, 70), marker=list(sizemode='diameter', opacity = 0.5),
          hover_info="text",
          text = ~paste(paste0("Team: ", possessionTeam),
                        paste0("Number of Attempts: ", attempts),
                        paste0("Season: ", season),
                        sep="<br>"))  %>%
  layout(title="Average Yard Line vs. Proportion of Successful Kicks <br> by Teams Each Season (2018-2020)", 
         yaxis=list(title="Proportion of Successful Kicks"),
         xaxis=list(title="Average Yard Line"),
         hovermode="compare")

```


Note that a successful kick is a kick that manages to score points- that is, a kick that goes through the goal post.

```{r, echo=FALSE, message=FALSE, warning=FALSE}

plt <- data %>%
  ggplot( aes(y=yardlineNumber, x=specialTeamsSuccess, color=possessionTeam)) +
  geom_boxplot(alpha=0.5)

ggplotly(plt) %>%
  layout(title="Yard Line of Field Goal Attempts per Team for 2018-2020", 
         yaxis=list(title="Yard Line"),
         xaxis=list(title="Kick Success"),
         hovermode="compare")
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

colour <- colorRampPalette(c("#C06C84", "#355C7D"))
plt1 <- data %>%
  ggplot( aes(x=yardlineNumber, fill=specialTeamsResult)) +
    geom_histogram( color="#e9ecef", alpha=0.6, binwidth = 2) +
    scale_fill_manual("Special Teams Result", values=c("#ddb0bd", "#C06C84", "#81374c", "#6C5B7B", "#355C7D", "#072543")) 

ggplotly(plt1) %>%
  layout(title="Field Goal Attempts by Yard Line", 
         yaxis=list(title="Count"),
         xaxis=list(title="Yard Line"),
         hovermode="compare")


```




